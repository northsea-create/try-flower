<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surprise!!!</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #f0f2f5;
            font-family: 'Arial', sans-serif;
        }
        canvas {
            display: block;
        }
        #pageTitle {
            font-size: 5em;
            color: #000000;
            margin-bottom: 15px;
            text-align: center;
        }
        #pageSubTitle {
            font-size: 1.4em;
            color: #4a4a4a;
            margin-top: 10px;
            margin-bottom: 30px;
            text-align: center;
            font-weight: normal;
        }
        .game-ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            pointer-events: none;
        }
        .game-ui-container > * {
            pointer-events: auto;
        }
        #startScreen, #winScreen {
            text-align: center;
        }
        #startButton, #restartButton {
            padding: 15px 30px;
            font-size: 1.2em;
            color: white;
            background-color: #3033d7;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }
        #startButton:hover, #restartButton:hover {
            background-color: #3033d7;
        }
        #winScreen {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        #winScreen h1 {
            font-size: 3em;
            color: #1e21b9;
            margin-bottom: 20px;
        }

        #footerCredit {
            position: absolute; /* ç›¸å¯¹äºbodyè¿›è¡Œç»å¯¹å®šä½ */
            bottom: 20px;       /* è·ç¦»é¡µé¢åº•éƒ¨15px */
            left: 0;            /* å…ˆå®šä½åˆ°å·¦è¾¹ */
            width: 100%;        /* å®½åº¦å æ»¡æ•´ä¸ªå±å¹• */
            text-align: center; /* æ–‡å­—æ°´å¹³å±…ä¸­ */
            font-size: 0.8em;   /* è¾ƒå°çš„å­—å· */
            color: #888888;     /* æµ…ç°è‰²ï¼Œä¸æŠ¢çœ¼ */
            z-index: 5;         /* ç¡®ä¿å®ƒä¸ä¼šè¢«ç”»å¸ƒæˆ–å…¶ä»–UIå…ƒç´ è½»æ˜“é®æŒ¡ï¼Œä½†åˆåœ¨ä¸»è¦UIä¹‹ä¸‹ */
            pointer-events: none; /* è®©å®ƒä¸æ‹¦æˆªé¼ æ ‡äº‹ä»¶ï¼Œå¦‚æœå®ƒå¯èƒ½è¦†ç›–å¯ç‚¹å‡»åŒºåŸŸ */
        }

        #winScreen p.win-message-body { /* æ›´ç²¾ç¡®åœ°é€‰æ‹©è¿™ä¸ªpæ ‡ç­¾ */
            font-size: 1em;       /* æ­£æ–‡å­—ä½“å¤§å°ï¼Œå¯ä»¥æ ¹æ®å†…å®¹è°ƒæ•´ */
            line-height: 1.6;     /* è¡Œé«˜ï¼Œè®©æ–‡å­—æ›´æ˜“è¯» */
            color: #555555;       /* æ­£æ–‡é¢œè‰²ï¼Œæ¯”æ ‡é¢˜æµ…ï¼Œæ¯”ç½²åæ·± */
            margin-top: 15px;     /* ä¸ä¸Šæ–¹æ ‡é¢˜çš„é—´è· */
            margin-bottom: 25px;  /* ä¸ä¸‹æ–¹æŒ‰é’®çš„é—´è· */
            max-width: 80%;       /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢æ–‡å­—è¿‡é•¿ï¼Œä½¿å…¶åœ¨å¼¹çª—å†…æ›´ç¾è§‚ */
            margin-left: auto;    /* é…åˆ max-width å®ç°æ°´å¹³å±…ä¸­ */
            margin-right: auto;   /* é…åˆ max-width å®ç°æ°´å¹³å±…ä¸­ */
            text-align: center;   /* å¦‚æœä½ å¸Œæœ›æ­£æ–‡ä¹Ÿå±…ä¸­å¯¹é½ */
            /* text-align: left; */ /* æˆ–è€…å·¦å¯¹é½ï¼Œçœ‹ä½ çš„å–œå¥½ */
        }

    </style>
</head>
<body>
    <div class="game-ui-container">
        <h1 id="pageTitle">Surprise!</h1>
        <h6 id="pageSubTitle">åŠªåŠ›é€‰ä¸­å°çŒ«çˆªå§</h6>
        <div id="startScreen">
            <button id="startButton">å¼€å§‹æ¸¸æˆ</button>
        </div>
        <div id="winScreen" style="display: none;">
            <h1>ğŸ‚ é™ˆé‘«ç”Ÿæ—¥å¿«ä¹å‘€ ğŸ‰</h1>
            <p class="win-message-body">
                çº¸ç«ç‘°å¤ªéš¾æºå¸¦äº†ï¼Œè®©æˆ‘å†™ä¸€æŸå§<br>
                æˆ–è®¸åœ¨ä¸“ä¸šèƒŒæ™¯çš„ä½ çœ‹æ¥<br>
                å±äºè¶…çº§å°å„¿ç§‘çš„è´´è„¸å¼€å¤§ï¼ˆæ‰‹åŠ¨ç‹—å¤´ï¼‰<br>
                ä½†ç¡®å®èŠ±äº†æˆ‘å¾ˆå¤šæ—¶é—´å’Œå¿ƒæ€<br>
                å¸Œæœ›è¿™ä¸ªå°å°äº’åŠ¨èƒ½ç»™ä½ å¸¦æ¥ä¸€ä¸æƒŠå–œå’Œå¿«ä¹ï¼<br>
                <br>
                å†æ¬¡ç¥ä½ ï¼Œ2025å¹´ç”Ÿæ—¥å¿«ä¹ï¼<br>
                é™ˆé‘«é™ˆé‘«ï¼Œå¤©å¤©å¼€å¿ƒï¼
            </p>
            <button id="restartButton">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <div id="footerCredit">
        2025/5/16 @ æ—éœå¼€ @ å—äº¬
    </div>

    <script>
        console.log("Main script tag started execution."); // æœ€é¡¶å±‚çš„æ—¥å¿—
        let currentRose = null;
        let particles = [];
        let bgGraphics;

        const GOLDEN_ANGLE = 137.5;
        const PETAL_LAYERS = 4;
        const PETALS_PER_LAYER_BASE = [30, 22, 16, 10];
        const LAYER_SCALE_FACTOR = [1.0, 0.7, 0.45, 0.25];
        const LAYER_HUE_SHIFT = [-10, -5, 5, 12];
        const LAYER_SATURATION_MOD = [0.95, 1.0, 1.05, 1.1];
        const LAYER_BRIGHTNESS_MOD = [1.0, 0.97, 0.94, 0.91];
        const monetFlowerColorPalettes = [
            { name: "ç³–ç²‰", h_range: [0, 10], s_range: [10, 20], b_range: [97, 100] },
            { name: "ç±³ç™½", h_range: [40, 50], s_range: [5, 15], b_range: [97, 100] },
            { name: "é›¾è“", h_range: [190, 210], s_range: [5, 15], b_range: [94, 100] },
            { name: "æ¡ƒç´«", h_range: [300, 320], s_range: [10, 30], b_range: [96, 100] },
            { name: "æ˜é»„", h_range: [48, 58], s_range: [30, 50], b_range: [96, 100] }
        ];

        const randomPhrases = [
            "å†¤ç§åè½¦è½¦", "åŠ¨ç‰©å›­æœ‰å¾ˆå¤šå°ç†ŠçŒ«å“¦","é•¿æ±Ÿè¾¹çš„è½æ—¥å¾ˆç¾å§","ä¸€èµ·æ‰“çƒå§","é€›åƒé€›åƒ", "ä½ çš„æ‰‹å¥½å¤§å•Š", "zou ni zou ni",
            "å¥½è´´å¿ƒå“¦", "å…³å…¬å·¡åŸ éŸ©ä¿¡ç‚¹å…µ","èµ°æˆ‘ä»¬å»çœ‹å°¸ä½“å§", "å¹²ç‚¹åäº‹ æ‰“ç‚¹åçƒ","æ•™ç»ƒæ•™æˆ‘æ‰“çƒ",
            "é™ˆé‘«é™ˆé‘«æ¯å¤©å¼€å¿ƒ", "ä½ æ€ä¹ˆä»€ä¹ˆéƒ½ä¼šå•Š","Aibooçš„è›‹ç³•å·å¾ˆå¥½åƒ", 
            "èº«ä½“å¥åº·","å·¥ä½œé¡ºåˆ©","æ­¥æ­¥é«˜å‡"
        ];
        let activePhrases = [];

        let gameState = "waiting";
        let gameBall = null;
        let gameStartTime;
        const BALL_TRANSFORM_DURATION = 20000;
        const BALL_INITIAL_SIZE = 15;
        const BALL_FINAL_SIZE = 70;
        const BALL_INITIAL_SPEED = 10;
        const BALL_FINAL_SPEED = 2;

        let pageTitleElement;
        let pageSubTitleElement;
        let startButton, startScreenContainer, winScreenContainer, restartButton;
        let gameUiContainer;

        function setup() {
            console.log("setup() function STARTED.");
            createCanvas(windowWidth, windowHeight); // ç”»å¸ƒå…¨å±

            colorMode(HSB, 360, 100, 100, 100);
            angleMode(DEGREES);
            ellipseMode(CENTER);
            noStroke();

            bgGraphics = createGraphics(width, height);
            bgGraphics.colorMode(HSB, 360, 100, 100, 100);
            drawMonetBackground(bgGraphics);

            pageTitleElement = select('#pageTitle');
            pageSubTitleElement = select('#pageSubTitle');
            startButton = select('#startButton');
            startScreenContainer = select('#startScreen');
            winScreenContainer = select('#winScreen');
            restartButton = select('#restartButton');
            gameUiContainer = select('.game-ui-container');

            if (!pageTitleElement || !pageSubTitleElement || !startScreenContainer || !winScreenContainer || !gameUiContainer || !startButton || !restartButton) {
                console.error("One or more UI elements were not found! Check HTML IDs and classes.");
            }

            startButton.mousePressed(startGame);
            restartButton.mousePressed(resetGame);
            
            textFont('Arial'); // è®¾ç½®ä¸€ä¸ªé»˜è®¤å­—ä½“ï¼ŒFloatingPhraseä¸­ä¼šç”¨åˆ°
            updateUI();
            console.log("setup() function FINISHED.");
        }

        function startGame() {
            console.log("startGame called");
            gameState = "playing";
            gameBall = new BouncingBall(
                BALL_INITIAL_SIZE, BALL_FINAL_SIZE,
                BALL_INITIAL_SPEED, BALL_FINAL_SPEED,
                BALL_TRANSFORM_DURATION
            );
            gameStartTime = millis();
            currentRose = null;
            particles = [];
            activePhrases = []; // æ¸…ç©ºä¸Šä¸€å±€çš„ç¥ç¦è¯­
            updateUI();
            console.log("startGame finished");
        }

        function resetGame() {
            gameState = "waiting";
            gameBall = null;
            currentRose = null;
            particles = [];
            activePhrases = []; // æ¸…ç©ºç¥ç¦è¯­
            updateUI();
        }

        function gameWon() {
            gameState = "won";
            updateUI();
        }

        function updateUI() {
            console.log("Updating UI, gameState: ", gameState);
            if (!pageTitleElement || !pageSubTitleElement || !startScreenContainer || !winScreenContainer || !gameUiContainer) {
                console.error("Cannot update UI - one or more container elements are null.");
                return;
            }

            if (gameState === "waiting") {
                pageTitleElement.style('display', 'block');
                pageSubTitleElement.style('display', 'block');
                startScreenContainer.style('display', 'block');
                winScreenContainer.style('display', 'none');
                gameUiContainer.style('pointer-events', 'auto');
            } else if (gameState === "playing") {
                pageTitleElement.style('display', 'none');
                pageSubTitleElement.style('display', 'none');
                startScreenContainer.style('display', 'none');
                winScreenContainer.style('display', 'none');
                gameUiContainer.style('pointer-events', 'none');
            } else if (gameState === "won") {
                pageTitleElement.style('display', 'none');
                pageSubTitleElement.style('display', 'none');
                startScreenContainer.style('display', 'none');
                winScreenContainer.style('display', 'block');
                gameUiContainer.style('pointer-events', 'auto');
            }
        }
        function drawMonetBackground(pg) {
            console.log("drawMonetBackground() STARTED.");

            pg.noStroke();

            // 1. çº¿æ€§æ¸å˜èƒŒæ™¯ (ä¿®æ”¹ä¸ºæµ…è“è‰²è°ƒ)
            let bgGradient = pg.drawingContext.createLinearGradient(0, 0, pg.width, pg.height);
            bgGradient.addColorStop(0, 'hsla(200, 50%, 96%, 1)'); // éå¸¸æµ…çš„å¤©è“è‰²
            bgGradient.addColorStop(1, 'hsla(220, 55%, 94%, 1)'); // ç•¥æ·±ä¸€ç‚¹çš„æŸ”å’Œæµ…è“
            pg.drawingContext.fillStyle = bgGradient;
            pg.rect(0, 0, pg.width, pg.height);

            // 2. ç‚¹ç¼€çš„æ¤­åœ†ç¬”è§¦ (ä¿®æ”¹ä¸ºè“è‰²ç³»)
            for (let i = 0; i < 800; i++) { // ç¬”è§¦æ•°é‡å¯ä»¥æ ¹æ®æ•ˆæœè°ƒæ•´
                let x = random(pg.width);
                let y = random(pg.height);
                let w = random(60, 120);
                let h = random(30, 60);

                // è‰²ç›¸èŒƒå›´è°ƒæ•´ä¸ºè“è‰²ç³»
                let hue = random(190, 230); // ç›´æ¥åœ¨é’è“åˆ°æµ…è“ä¹‹é—´éšæœº
                let saturation = random(15, 40); // è°ƒæ•´é¥±å’Œåº¦ï¼Œè®©é¢œè‰²æ›´æ˜æ˜¾ä¸€ç‚¹ä½†ä»æŸ”å’Œ
                let brightness = random(90, 98); // ä¿æŒé«˜äº®åº¦
                let alpha = random(6, 18);      // è°ƒæ•´é€æ˜åº¦

                pg.fill(hue, saturation, brightness, alpha);
                pg.ellipse(x, y, w, h);
            }

            // 3. ä¸­å¿ƒåä¸Šçš„å…‰æ„Ÿ (ä¿æŒç™½è‰²æˆ–å¾®è°ƒ)
            let glowGradient = pg.drawingContext.createRadialGradient(
                pg.width / 2, pg.height * 0.35, 50,  // å…‰å¿ƒä½ç½®
                pg.width / 2, pg.height * 0.35, pg.width * 0.7 // å…‰æ™•æ‰©æ•£èŒƒå›´
            );
            // ä¿æŒç™½è‰²å…‰æ™•ï¼Œé€šå¸¸æ•ˆæœå¥½
            glowGradient.addColorStop(0, 'hsla(0, 0%, 100%, 0.12)');
            glowGradient.addColorStop(1, 'hsla(0, 0%, 100%, 0)');
            // æˆ–è€…å¸¦ä¸€ç‚¹è“è‰²è°ƒçš„å…‰æ™•æ ¸å¿ƒ:
            // glowGradient.addColorStop(0, 'hsla(210, 30%, 98%, 0.12)');
            // glowGradient.addColorStop(1, 'hsla(210, 30%, 98%, 0)');


            pg.drawingContext.fillStyle = glowGradient;
            pg.ellipse(pg.width / 2, pg.height * 0.35, pg.width * 1.4, pg.height * 1.2);
            console.log("drawMonetBackground() FINISHED.");
        }

        function draw() {
            console.log("draw() function CALLED - frameCount:", frameCount); // è¿™ä¸ªä¼šå¤§é‡è¾“å‡ºï¼Œä½†èƒ½ç¡®è®¤drawæ˜¯å¦åœ¨è·‘
            image(bgGraphics, 0, 0);

            if (gameState === "playing" && gameBall) {
                gameBall.update();
                gameBall.display();
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].display();
                if (particles[i].isDead()) particles.splice(i, 1);
            }

            if (currentRose) {
                currentRose.update();
                currentRose.display();
                if (currentRose.isFullyBloomed()) currentRose.hoverEffect(mouseX, mouseY);
            }

            for (let i = activePhrases.length - 1; i >= 0; i--) {
                activePhrases[i].update();
                activePhrases[i].display();
                if (activePhrases[i].isDead()) activePhrases.splice(i, 1);
            }
        }

        function mousePressed() {
             // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åº”ç”±ç”»å¸ƒå¤„ç†
            if (gameUiContainer && gameUiContainer.elt.style.pointerEvents === 'none') {
                // UIä¸æ‹¦æˆªäº‹ä»¶ï¼Œç”»å¸ƒå¤„ç†ç‚¹å‡»
                if (mouseX < 0 || mouseX > width || mouseY < 0 || mouseY > height) return; // ç‚¹å‡»åœ¨ç”»å¸ƒå¤–åˆ™å¿½ç•¥
            } else {
                // UIæ‹¦æˆªäº‹ä»¶(waitingæˆ–wonçŠ¶æ€), å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æŒ‰é’®è€Œæ˜¯ç©ºç™½å¤„ï¼Œ
                // å¹¶ä¸”äº‹ä»¶èƒ½ç©¿é€åˆ°canvasï¼Œè¿™é‡Œä¹Ÿä¼šæ‰§è¡Œã€‚
                // ä½†é€šå¸¸DOMæŒ‰é’®çš„äº‹ä»¶ä¼šä¼˜å…ˆå¤„ç†ã€‚
                // ä¸ºé¿å…åœ¨æŒ‰é’®ä¸Šç‚¹å‡»æ—¶è¿˜è§¦å‘è¿™é‡Œçš„é€»è¾‘ï¼Œå¯ä»¥åŠ ä¸€ä¸ªæ›´ç²¾ç¡®çš„åˆ¤æ–­ï¼Œ
                // ä½†ç›®å‰çš„ç»“æ„ï¼Œä¸»è¦ä¾èµ–pointer-eventsã€‚
            }


            if (gameState === "playing") {
                if (gameBall && gameBall.isClicked(mouseX, mouseY)) {
                    gameWon();
                } else {
                     // ç¡®ä¿ç‚¹å‡»åœ¨ç”»å¸ƒå†…
                    if (mouseX >= 0 && mouseX <= width && mouseY >= 0 && mouseY <= height) {
                        let chosenPalette = random(monetFlowerColorPalettes);
                        currentRose = new Rose(mouseX, mouseY, chosenPalette);
                        for (let i = 0; i < 25; i++) { particles.push(new Particle(mouseX,mouseY,random(chosenPalette.h_range[0],chosenPalette.h_range[1])+random(-5,5),random(chosenPalette.s_range[0],chosenPalette.s_range[1])*random(0.9,1.1),random(chosenPalette.b_range[0],chosenPalette.b_range[1])*random(0.95,1.05),0.6)); }
                        let phraseText = random(randomPhrases);
                        let phraseX = mouseX + random(-30, 30);
                        let phraseY = mouseY - (currentRose ? currentRose.baseScale * 15 : 30);
                        activePhrases.push(new FloatingPhrase(phraseText, phraseX, phraseY));
                    }
                }
            } else if (gameState === "waiting") {
                 // ç¡®ä¿ç‚¹å‡»åœ¨ç”»å¸ƒå†…
                 if (mouseX >= 0 && mouseX <= width && mouseY >= 0 && mouseY <= height) {
                     let chosenPalette = random(monetFlowerColorPalettes);
                     currentRose = new Rose(mouseX, mouseY, chosenPalette);
                     for (let i = 0; i < 25; i++) { particles.push(new Particle(mouseX,mouseY,random(chosenPalette.h_range[0],chosenPalette.h_range[1])+random(-5,5),random(chosenPalette.s_range[0],chosenPalette.s_range[1])*random(0.9,1.1),random(chosenPalette.b_range[0],chosenPalette.b_range[1])*random(0.95,1.05),0.6)); }
                     // let phraseText = random(randomPhrases);
                     // let phraseX = mouseX + random(-30, 30);
                     // let phraseY = mouseY - (currentRose ? currentRose.baseScale * 15 : 30);
                     // activePhrases.push(new FloatingPhrase(phraseText, phraseX, phraseY));
                 }
            }
        }

        class BouncingBall {
            constructor(initialSize, finalSize, initialSpeed, finalSpeed, transformDuration) {
                this.pos = createVector(random(width * 0.2, width * 0.8), random(height * 0.2, height * 0.8));
                this.vel = p5.Vector.random2D(); this.initialSize = initialSize; this.finalSize = finalSize;
                this.currentSize = initialSize; this.initialSpeed = initialSpeed; this.finalSpeed = finalSpeed;
                this.currentSpeed = initialSpeed; this.vel.setMag(this.currentSpeed);
                this.transformDuration = transformDuration; this.creationTime = millis();
                this.color = color(random(360), 80, 90);
            }
            update() {
                let elapsedTime = millis() - this.creationTime;
                let progress = constrain(elapsedTime / this.transformDuration, 0, 1);
                this.currentSize = lerp(this.initialSize, this.finalSize, progress);
                this.currentSpeed = lerp(this.initialSpeed, this.finalSpeed, progress);
                this.vel.setMag(this.currentSpeed); this.pos.add(this.vel);
                if (this.pos.x-this.currentSize/2<0||this.pos.x+this.currentSize/2>width){this.vel.x*=-1;this.pos.x=constrain(this.pos.x,this.currentSize/2,width-this.currentSize/2);}
                if (this.pos.y-this.currentSize/2<0||this.pos.y+this.currentSize/2>height){this.vel.y*=-1;this.pos.y=constrain(this.pos.y,this.currentSize/2,height-this.currentSize/2);}
            }
            // åœ¨ BouncingBall ç±»ä¸­

            display() {
                push(); // ä¿å­˜æ•´ä½“çš„ç»˜å›¾çŠ¶æ€
                translate(this.pos.x, this.pos.y); // å°†åŸç‚¹ç§»åŠ¨åˆ°å°çƒçš„ä¸­å¿ƒä½ç½®

                // --- 1. ç»˜åˆ¶åº•çƒ ---
                // ç™½è‰²ï¼Œé€æ˜åº¦10%
                // åœ¨ HSB/HSLæ¨¡å¼ä¸‹ï¼Œç™½è‰²é€šå¸¸æ˜¯ S=0, B/L=100
                // æˆ–è€…ç›´æ¥ç”¨ fill(R, G, B, Alpha_0_255)
                // ä¸ºç¡®ä¿é¢œè‰²æ¨¡å¼çš„ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å‡è®¾ä½ å…¨å±€ç”¨äº† HSB, 360, 100, 100, 100
                let ballHue = 0;        // å¯¹äºç™½è‰²ï¼Œè‰²ç›¸ä¸é‡è¦
                let ballSaturation = 0; // ç™½è‰²é¥±å’Œåº¦ä¸º0
                let ballBrightness = 100; // ç™½è‰²äº®åº¦ä¸º100
                let ballAlpha = 10;     // é€æ˜åº¦ 10 (åœ¨0-100èŒƒå›´å†…)

                fill(ballHue, ballSaturation, ballBrightness, ballAlpha);
                noStroke(); // åº•çƒé€šå¸¸ä¸éœ€è¦æè¾¹
                ellipse(0, 0, this.currentSize, this.currentSize); // åœ¨ (0,0) ç»˜åˆ¶ï¼Œå› ä¸ºå·²ç»translateäº†

                // --- 2. ç»˜åˆ¶çŒ«çˆªå›¾æ¡ˆ (åœ¨åº•çƒä¹‹ä¸Š) ---
                let pawHue = 210;       
                let pawSaturation = 50; 
                let pawBrightness = 80;  
                let pawAlpha = 80;      // é€æ˜åº¦ 

                fill(pawHue, pawSaturation, pawBrightness, pawAlpha);
                noStroke(); // çŒ«çˆªå›¾æ¡ˆé€šå¸¸ä¹Ÿä¸éœ€è¦æè¾¹ï¼Œé™¤éæœ‰ç‰¹æ®Šè®¾è®¡

                // --- è®¡ç®—çŒ«çˆªç»˜åˆ¶çš„ç¼©æ”¾å› å­å’Œå°ºå¯¸ ---
                // çŒ«çˆªåº”è¯¥æ¯”åº•çƒå°ï¼Œçœ‹èµ·æ¥åœ¨å†…éƒ¨ã€‚æˆ‘ä»¬è®©çŒ«çˆªçš„â€œæœ‰æ•ˆç›´å¾„â€ä¸ºåº•çƒç›´å¾„çš„æŸä¸ªæ¯”ä¾‹ã€‚
                let pawAreaScale = 0.75; // çŒ«çˆªå›¾æ¡ˆåŒºåŸŸå åº•çƒç›´å¾„çš„75%
                let effectivePawSize = this.currentSize * pawAreaScale;

                // æˆ‘ä»¬åŸºäºä¸€ä¸ªè®¾è®¡åŸºå‡†å°ºå¯¸ï¼ˆæ¯”å¦‚100ï¼‰æ¥å®šä¹‰çŒ«çˆªå„éƒ¨åˆ†çš„ç›¸å¯¹æ¯”ä¾‹ï¼Œ
                // ç„¶åç”¨ effectivePawSize / 100 æ¥å¾—åˆ°å½“å‰çš„ç¼©æ”¾å› å­ã€‚
                let designBaseSize = 100; // çŒ«çˆªè®¾è®¡çš„åŸºå‡†å¤§å° (å¯ä»¥ä»»æ„è®¾ï¼Œæ–¹ä¾¿æ¯”ä¾‹è®¡ç®—)
                let scaleFactor = effectivePawSize / designBaseSize;

                // --- ç»˜åˆ¶ä¸»è‚‰å« (å‚è€ƒå›¾ç‰‡ï¼Œç•¥åƒåœ†è§’å€’ä¸‰è§’æˆ–å¿ƒå½¢ä¸‹åŠéƒ¨åˆ†) ---
                // ä¸»è‚‰å«çš„å®½åº¦å’Œé«˜åº¦æ¯”ä¾‹ (åŸºäºdesignBaseSize)
                let mainPadWidth = 60 * scaleFactor;
                let mainPadHeight = 50 * scaleFactor;
                // ä¸»è‚‰å«çš„Yè½´åç§»ï¼Œä½¿å…¶åœ¨çƒçš„ä¸­å¿ƒåä¸‹ä¸€ç‚¹ï¼Œç»™æŒ‡å¤´ç•™ç©ºé—´
                let mainPadYOffset = 20 * scaleFactor;
                // ä½¿ç”¨ ellipse æ¨¡æ‹Ÿï¼Œå¯ä»¥è°ƒæ•´å‚æ•°ä½¿å…¶æ›´åƒ
                ellipse(0, mainPadYOffset, mainPadWidth, mainPadHeight);

                // æŒ‡å¤´è‚‰å«çš„å¤§å° (åŸºäºdesignBaseSize) - ä¿æŒä¸å˜æˆ–ç•¥å¾®è°ƒæ•´
                let fingerPadSize = 25 * scaleFactor;

                // æŒ‡å¤´è‚‰å«çš„Yè½´åç§» (ç›¸å¯¹äºçƒä¸­å¿ƒï¼Œåœ¨ä¸»è‚‰å«ä¸Šæ–¹) - ä¿æŒä¸å˜æˆ–ç•¥å¾®è°ƒæ•´
                let fingerRowYOffset = -30 * scaleFactor;

                // 1. ä¸­é—´çš„æŒ‡å¤´ (é€šå¸¸ç•¥å¾®é ä¸Š/é å‰)
                let middleFingerYAdjust = -3 * scaleFactor; // è®©ä¸­é—´æŒ‡å¤´æ¯”ä¸¤ä¾§çš„å†é«˜ä¸€ç‚¹ç‚¹
                ellipse(0, fingerRowYOffset + middleFingerYAdjust, fingerPadSize, fingerPadSize);

                // 2. å·¦ä¾§çš„æŒ‡å¤´
                let sideFingerXOffset = 40 * scaleFactor; // è°ƒæ•´å·¦å³æŒ‡å¤´ä¸ä¸­å¿ƒçš„Xè½´è·ç¦»
                let sideFingerYAdjust = 12 * scaleFactor;  // è®©ä¸¤ä¾§æŒ‡å¤´æ¯”ä¸­é—´çš„ç•¥ä½ä¸€ç‚¹ç‚¹ï¼Œå½¢æˆè½»å¾®å¼§åº¦
                ellipse(-sideFingerXOffset, fingerRowYOffset + sideFingerYAdjust, fingerPadSize, fingerPadSize);

                // 3. å³ä¾§çš„æŒ‡å¤´
                ellipse(sideFingerXOffset, fingerRowYOffset + sideFingerYAdjust, fingerPadSize, fingerPadSize);

                
                pop(); // æ¢å¤åˆ° translate ä¹‹å‰çš„ç»˜å›¾çŠ¶æ€
            }

            isClicked(mx,my){let d=dist(mx,my,this.pos.x,this.pos.y);return d<this.currentSize/2;}
        }

        class Rose {
            constructor(x, y, chosenFlowerPalette) {
                this.x = x;
                this.y = y;
                this.chosenFlowerPalette = chosenFlowerPalette;
                this.baseScale = random(1.8, 7.5);
                this.animationProgress = 0;
                this.animationSpeed = random(0.02, 0.033);
                this.layers = [];
                let baseHueForRose = random(this.chosenFlowerPalette.h_range[0], this.chosenFlowerPalette.h_range[1]);
                for (let i = 0; i < PETAL_LAYERS; i++) {
                    this.layers.push({
                        petalCount: PETALS_PER_LAYER_BASE[i] + floor(random(-3, 3)),
                        scale: this.baseScale * LAYER_SCALE_FACTOR[i],
                        rotationOffset: random(360),
                        hue: (baseHueForRose + LAYER_HUE_SHIFT[i] + 360) % 360,
                        // ä½¿ç”¨ layer è‡ªèº«çš„ saturation å’Œ brightness ä½œä¸ºæ¸å˜çš„åŸºç¡€
                        saturation: constrain(random(this.chosenFlowerPalette.s_range[0], this.chosenFlowerPalette.s_range[1]) * LAYER_SATURATION_MOD[i], this.chosenFlowerPalette.s_range[0] * 0.7, 90),
                        brightness: constrain(random(this.chosenFlowerPalette.b_range[0], this.chosenFlowerPalette.b_range[1]) * LAYER_BRIGHTNESS_MOD[i], this.chosenFlowerPalette.b_range[0] * 0.8, 100),
                    });
                }
                this.petalShapeType = floor(random(10));
            }

            update() {
                if (this.animationProgress < 1) {
                    this.animationProgress += this.animationSpeed;
                    this.animationProgress = min(this.animationProgress, 1);
                }
            }

            isFullyBloomed() {
                return this.animationProgress >= 1;
            }

            display() {
                push();
                translate(this.x, this.y);
                for (let i = this.layers.length - 1; i >= 0; i--) {
                    this.drawLayer(this.layers[i]);
                }
                pop();
            }

            drawLayer(layer) {
                let animatedPetalCount = floor(layer.petalCount * pow(this.animationProgress, 2.8));
                for (let n = 0; n < animatedPetalCount; n++) {
                    let angle = n * GOLDEN_ANGLE + layer.rotationOffset;
                    let r = layer.scale * sqrt(n) * 1.8 * this.animationProgress;
                    let petalX = r * cos(angle);
                    let petalY = r * sin(angle);
                    let currentPetalScaleFactor = pow(this.animationProgress, 0.9);
                    let petalWidth = layer.scale * random(5, 9) * currentPetalScaleFactor;
                    let petalHeight = layer.scale * random(10, 16) * currentPetalScaleFactor;

                    if (petalWidth < 0.5 || petalHeight < 0.5) continue;

                   // åœ¨ Rose ç±»çš„ drawLayer æ–¹æ³•ä¸­ï¼š
        // ... (petalX, petalY, petalWidth, petalHeight ç­‰è®¡ç®—) ...

                    push();
                    translate(petalX, petalY);
                    rotate(angle + 90);

                    // --- æ¸å˜é¢œè‰²å‡†å¤‡ï¼ŒåŸºäº layer çš„ HSB ---
                    let baseH = (layer.hue + random(-1, 1) + 360) % 360;
                    let originalS = layer.saturation;
                    let originalB = layer.brightness;
                    let fillAlphaPercent = (gameState === "playing" ? 70 : 95) + random(-2, 5);

                    let startS = constrain(originalS * 0.6, 5, 50);
                    let startB = constrain(originalB * 2, 90, 100);                    
                    let colorStartStr = `hsla(${baseH}, ${startS}%, ${startB}%, ${fillAlphaPercent / 100})`;

                    let endS = constrain(originalS * 3, 10, 95);
                    let endB = constrain(originalB * 0.3, 80, 98);
                    let endHue = (baseH + random(5, 15) + 360) % 360; // ä¾‹å¦‚ï¼Œè®©æ ¹éƒ¨è‰²ç›¸åç§»5-15åº¦
                    let colorEndStr = `hsla(${endHue}, ${endS}%, ${endB}%, ${fillAlphaPercent / 100})`;
                    //let colorEndStr = `hsla(${baseH}, ${endS}%, ${endB}%, ${fillAlphaPercent / 100})`;

                    // --- ä¿®æ”¹æè¾¹é¢œè‰²ä¸ºé»‘è‰² ---
                    let strokeAlphaPercent = (gameState === "playing" ? 40 : 55); // ä¿æŒä¹‹å‰çš„é€æ˜åº¦é€»è¾‘
                    // ç›´æ¥å®šä¹‰é»‘è‰²æè¾¹å­—ç¬¦ä¸²
                    // HSLA for black: H and S don't matter, L=0%
                    let strokeColorStr = `hsla(0, 0%, 0%, ${strokeAlphaPercent / 70})`; 
                    
                    this.drawPetalShape(0, 0, petalWidth, petalHeight, this.petalShapeType, colorStartStr, colorEndStr, strokeColorStr);

                    pop();
        // ... (å¾ªç¯ç»“æŸ) ...
                }
            }

            // ä¿®æ”¹ drawPetalShape ä»¥æ¥å—å¹¶åº”ç”¨æ¸å˜
            // åœ¨ Rose ç±»ä¸­
            // ä¿®æ”¹ drawPetalShape æ–¹æ³•
            drawPetalShape(x, y, w, h, type = 0, gradColorStart, gradColorEnd, strokeColorCSS) { // strokeColorCSS æ˜¯CSSå­—ç¬¦ä¸²
                const ctx = drawingContext;

                // 1. è®¾ç½®åŸç”Ÿ Canvas çš„å¡«å……æ ·å¼ä¸ºæ¸å˜
                let gradient = ctx.createLinearGradient(x, y - h * 0.4, x, y + h * 0.4);
                gradient.addColorStop(0, gradColorStart);
                gradient.addColorStop(1, gradColorEnd);
                ctx.fillStyle = gradient;

                // 2. ä½¿ç”¨ P5.js çš„ stroke() å’Œ strokeWeight() æ¥è®¾ç½®æè¾¹
                // æˆ‘ä»¬éœ€è¦ä» strokeColorCSS (ä¾‹å¦‚ 'hsla(H,S%,L%,A)') ä¸­æå–å‡º P5.js stroke() éœ€è¦çš„å‚æ•°
                // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„è§£æï¼Œå‡è®¾ strokeColorCSS æ˜¯ 'hsla(h,s%,l%,a)' æ ¼å¼
                // æ›´å¥å£®çš„åšæ³•æ˜¯ç›´æ¥ä¼ é€’ H, S, B, Alpha å€¼ç»™è¿™ä¸ªå‡½æ•°
                if (strokeColorCSS && strokeColorCSS !== "transparent") {
                    // è§£æ HSLA å­—ç¬¦ä¸²ä»¥ä¾› p5.stroke() ä½¿ç”¨ã€‚
                    // æ³¨æ„ï¼šp5.color() å¯ä»¥ç›´æ¥è§£æ CSS é¢œè‰²å­—ç¬¦ä¸²ï¼
                    let p5StrokeColor = color(strokeColorCSS); // è®© p5.js è§£æ CSS é¢œè‰²å­—ç¬¦ä¸²
                    stroke(p5StrokeColor); // åº”ç”¨è§£æåçš„é¢œè‰²
                    strokeWeight(0.3);
                } else {
                    noStroke(); // å¦‚æœä¸æƒ³è¦æè¾¹
                }

                // 3. ä½¿ç”¨ P5.js å®šä¹‰å’Œç»˜åˆ¶å½¢çŠ¶è·¯å¾„
                beginShape();
                // --- å†…éƒ¨æ˜¯åŸæ¥çš„ switch-case é¡¶ç‚¹å®šä¹‰ ---
                switch (type) {
                    case 0: curveVertex(x,y-h);curveVertex(x+w*0.2,y-h*0.4);curveVertex(x+w*0.3,y);curveVertex(x,y+h*0.3);curveVertex(x-w*0.3,y);curveVertex(x-w*0.2,y-h*0.4);curveVertex(x,y-h);break;
                    case 1: curveVertex(x, y - h * 0.7); curveVertex(x + w * 0.4, y - h * 0.2); curveVertex(x + w * 0.25, y + h * 0.3); curveVertex(x, y + h * 0.5); curveVertex(x - w * 0.25, y + h * 0.3); curveVertex(x - w * 0.4, y - h * 0.2); curveVertex(x, y - h * 0.7); break;
                    case 2: curveVertex(x, y - h * 0.5); curveVertex(x + w * 0.5, y); curveVertex(x + w * 0.3, y + h * 0.4); curveVertex(x, y + h * 0.5); curveVertex(x - w * 0.3, y + h * 0.4); curveVertex(x - w * 0.5, y); curveVertex(x, y - h * 0.5); break;
                    case 3: vertex(x, y - h * 0.6); vertex(x + w * 0.5, y - h * 0.1); vertex(x + w * 0.3, y + h * 0.4); vertex(x, y + h * 0.2); vertex(x - w * 0.3, y + h * 0.4); vertex(x - w * 0.5, y - h * 0.1); vertex(x, y - h * 0.6); break;
                    case 4: curveVertex(x, y - h * 0.6); curveVertex(x + w * 0.5, y - h * 0.4); curveVertex(x + w * 0.3, y + h * 0.3); curveVertex(x, y + h * 0.5); curveVertex(x - w * 0.3, y + h * 0.3); curveVertex(x - w * 0.5, y - h * 0.4); curveVertex(x, y - h * 0.6); break;
                    case 5: curveVertex(x, y - h * 0.5); curveVertex(x + w * 0.35, y - h * 0.4); curveVertex(x + w * 0.45, y); curveVertex(x, y + h * 0.4); curveVertex(x - w * 0.45, y); curveVertex(x - w * 0.35, y - h * 0.4); curveVertex(x, y - h * 0.5); break;
                    case 6: curveVertex(x, y - h * 0.6); curveVertex(x + w * 0.5, y - h * 0.2); curveVertex(x + w * 0.3, y + h * 0.4); curveVertex(x, y + h * 0.6); curveVertex(x - w * 0.3, y + h * 0.4); curveVertex(x - w * 0.5, y - h * 0.2); curveVertex(x, y - h * 0.6); break;
                    case 7: curveVertex(x, y - h); curveVertex(x + w * 0.35, y - h * 0.2); curveVertex(x + w * 0.25, y + h * 0.6); curveVertex(x, y + h * 0.8); curveVertex(x - w * 0.25, y + h * 0.6); curveVertex(x - w * 0.35, y - h * 0.2); curveVertex(x, y - h); break;
                    case 8: vertex(x, y - h * 0.6); vertex(x + w * 0.4, y - h * 0.2); vertex(x + w * 0.3, y + h * 0.35); vertex(x, y + h * 0.2); vertex(x - w * 0.3, y + h * 0.35); vertex(x - w * 0.4, y - h * 0.2); vertex(x, y - h * 0.6); break;
                    case 9: curveVertex(x, y - h * 0.6); curveVertex(x + w * 0.4, y - h * 0.3); curveVertex(x + w * 0.3, y + h * 0.5); curveVertex(x, y + h * 0.65); curveVertex(x - w * 0.3, y + h * 0.5); curveVertex(x - w * 0.4, y - h * 0.3); curveVertex(x, y - h * 0.6); break;
                }
                endShape(CLOSE); // P5.js ä¼šä½¿ç”¨ ctx.fillStyle (æˆ‘ä»¬è®¾ç½®çš„æ¸å˜) å’Œ p5çš„strokeè®¾ç½®æ¥æ¸²æŸ“
            }

            hoverEffect(mx, my) {
                if (!this.isFullyBloomed() || gameState === "playing") return;
                let d = dist(mx, my, this.x, this.y);
                let hoverRadius = this.baseScale * sqrt(this.layers[0].petalCount) * 1.1;
                if (d < hoverRadius) {
                    if (frameCount % 5 === 0) {
                        let p_hue = random(this.chosenFlowerPalette.h_range[0], this.chosenFlowerPalette.h_range[1]) + random(-8, 8);
                        let p_sat = random(this.chosenFlowerPalette.s_range[0], this.chosenFlowerPalette.s_range[1]) * random(0.85, 1.15);
                        let p_bri = random(this.chosenFlowerPalette.b_range[0], this.chosenFlowerPalette.b_range[1]) * random(0.9, 1.1);
                        particles.push(new Particle(this.x + randomGaussian(0, this.baseScale * 1.2), this.y + randomGaussian(0, this.baseScale * 1.2), p_hue, p_sat, p_bri, 0.55));
                    }
                }
            }
        }

        class FloatingPhrase{
            constructor(text,x,y){
                this.text=text;
                this.pos=createVector(x,y+random(-10,10));
                this.lifespan=180;
                this.initialLifespan=this.lifespan;
                this.currentAlpha=100; // Use 0-100 for HSB alpha
                this.textSize=random(15,20);
                this.textColor=color(random(220,240),random(50,75),random(85,100),this.currentAlpha);
            }
            update(){
                this.lifespan--;
                this.currentAlpha=map(this.lifespan,0,this.initialLifespan,0,100);
                this.textColor.setAlpha(constrain(this.currentAlpha,0,100));
                this.pos.y-=0.3;
            }
            display(){
                push();
                fill(this.textColor);
                noStroke();
                textAlign(CENTER,BOTTOM);
                textSize(this.textSize);
                text(this.text,this.pos.x,this.pos.y);
                pop();
            }
            isDead(){return this.lifespan<=0;}
        }

        class Particle{constructor(x,y,hue,saturation,brightness,sizeMultiplier=1){this.pos=createVector(x,y);let angle=random(360);let speed=random(0.6,2.0);this.vel=createVector(cos(angle)*speed,sin(angle)*speed);this.acc=createVector(randomGaussian(0,0.012),randomGaussian(0,0.012)-0.007);this.lifespan=random(55,150);this.baseHue=hue;this.baseSaturation=saturation;this.baseBrightness=brightness;this.size=random(2.0,5.5)*sizeMultiplier;this.originalLifespan=this.lifespan;}update(){this.vel.add(this.acc);this.pos.add(this.vel);this.lifespan-=1.25;this.vel.mult(0.982);}display(){noStroke();let alpha=map(this.lifespan,0,this.originalLifespan,0,65);fill((this.baseHue+map(this.lifespan,0,this.originalLifespan,15,0)+360)%360,constrain(this.baseSaturation+randomGaussian(0,3),10,85),constrain(this.baseBrightness+randomGaussian(0,3),80,100),constrain(alpha,0,100));ellipse(this.pos.x,this.pos.y,this.size);}isDead(){return this.lifespan<0;}}

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            bgGraphics = createGraphics(width, height);
            bgGraphics.colorMode(HSB, 360, 100, 100, 100);
            drawMonetBackground(bgGraphics);
            resetGame();
        }
    </script>
</body>
</html>
